# 故障模型与容错（Failure Model & Fault Tolerance）

- Fail-Stop、Crash-Recovery、Network Partition、Byzantine
- FLP 不可能性、超时和随机化、Quorum 容错界

## 故障模型

- Fail-Stop：节点一旦故障即停止，不产生任意行为。
- Omission（遗漏）：应发送/接收的消息被遗漏（丢失/未处理），常见于网络抖动、队列溢出。
- Timing（时序）：操作在时间约束内未完成或超时，导致违背时序假设（部分同步中的延迟上界被暂时破坏）。
- Crash-Recovery：节点可能宕机并恢复，需 WAL/快照保证持久性与幂等恢复。
- 网络分区：消息可能丢失/乱序/重复/延迟；以超时近似失败检测。
- 拜占庭（Byzantine）：节点可能任意/恶意行为；需 BFT 协议（PBFT/Tendermint/HotStuff）。

## 不可能性与下界

- FLP：在完全异步系统中，不存在确定性的、在任意故障模式下保证终止的共识算法。
- 现实系统采用部分同步模型（随机化超时、心跳）以获得实践可用的活性。
  - 线性一致性在存在分区时不可与可用性同时满足（CAP），需在策略中显式取舍。

## Quorum 与容错能力

- N 副本、最多 f 故障时：
  - 崩溃容错（CFT）：`N ≥ 2f + 1`（多数派）
  - 拜占庭容错（BFT）：`N ≥ 3f + 1`（PBFT 原则），部分协议在实际工程中采用 `3f+2` 以容纳实现细节

## 故障注入与恢复策略

- 注入：消息丢弃、重排、延迟、重复；节点崩溃/恢复；磁盘写后回滚；时钟跃迁。
- 恢复：先加载最新快照，回放日志至 `commit_index`；网络恢复后触发反熵同步。
  - 验证：恢复后状态机终态与 `commit_index` 对齐；拒绝跨任期非法提交。

### Chaos 场景清单（示例）

- 网络：
  - 单向丢包（A→B 丢，B→A 正常），往返时延随机抖动（P50/95/99 配置）。
  - 分区：将集群切为多数派与少数派；交替合并/再分区。
- 进程/主机：
  - 领导者崩溃与频繁重启；Follower 抖动；时钟快/慢/跳跃。
- 存储：
  - WAL 同步失败/落后、快照加载失败；磁盘写入延迟长尾。

观测指标：

- 错误率（请求级/阶段级）、恢复时间（RTO）、恢复点目标（RPO）、误报率（错误隔离/错误降级触发率）。
- 共识层：选举次数、read-index 成功率、提交推进速率；复制层：ACK 分布、尾延迟（P99.9）。
- 恢复质量：RTO/RPO、丢失窗口、数据校验和一致性、读修复次数。

## 与代码接口的对应

- `transport`：重试、超时、幂等键与去重缓存。
- `storage`：WAL、快照、恢复不变式。
- `consensus`：选举超时、心跳、日志匹配；BFT 需单独特性。

## 进一步阅读

- Wiki：`FLP impossibility`、`Byzantine fault`、`Failure detector`
- 课程：MIT 6.824（Fault Tolerance）、UWash CSE452（Failure & Time）
- 论文：PBFT、Tendermint、HotStuff、Viewstamped Replication、Raft

## 练习与思考

1. 实现一个故障检测器，能够区分网络分区、节点崩溃和网络延迟，并提供相应的恢复策略。
2. 设计一个拜占庭容错系统，支持动态节点加入和离开，并保证系统在恶意节点存在时的安全性。
3. 构建一个故障注入测试框架，能够模拟各种故障场景并验证系统的容错能力。
4. 开发一个故障恢复协调器，在故障发生后能够自动选择最优的恢复策略并执行。

## 两地三中心与冲突解决导航

- 部署形态：同城双活（两个可用区/机房）+ 异地容灾（第三中心）。
- 放置策略：
  - 写路径：优先同城多数派提交（低延迟），异地异步复制以降低 RPO。
  - 读路径：本地优先读；对强一致读使用 read-index/租约读保障安全。
- 合并与冲突：
  - 最终一致数据：使用基于版本向量/时间戳+幂等合并规则（如 LWW、CRDT）。
  - 强一致数据：通过共识跨区提交；分区时禁止跨区写或降级为只读。
- 迁移与演练：周期性演练故障转移/回切，校验快照/日志与数据校验和；记录 RTO/RPO 与业务影响窗口。

## 快速导航

- 分布式系统总纲：`../README.md`
- 共识机制：`../consensus/README.md`
- 复制机制：`../replication/README.md`
- 存储系统：`../storage/README.md`
