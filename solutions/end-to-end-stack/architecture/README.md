# 端到端分布式计算参考栈

## 架构概览

本参考栈展示了如何将 Foundations + DataFusion 与 Vector 分布式拓扑结合，构建完整的分布式计算解决方案。

## 系统架构

```text
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用     │    │   客户端应用     │    │   客户端应用     │
│  (Python/Go/    │    │  (Python/Go/    │    │  (Python/Go/    │
│   Java/Rust)    │    │   Java/Rust)    │    │   Java/Rust)    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │     负载均衡器             │
                    │   (gRPC-LB/DNS)           │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │   DataFusion 服务集群      │
                    │  (Foundations + DF)       │
                    │  ┌─────┐ ┌─────┐ ┌─────┐  │
                    │  │ DF1 │ │ DF2 │ │ DF3 │  │
                    │  └─────┘ └─────┘ └─────┘  │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │     可观测性层             │
                    │  ┌─────────┐ ┌─────────┐  │
                    │  │ Vector  │ │ Vector  │  │
                    │  │  Edge   │ │  Agg    │  │
                    │  └─────────┘ └─────────┘  │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │     存储层                 │
                    │  ┌─────────┐ ┌─────────┐  │
                    │  │ClickHouse│ │Prometheus││
                    │  └─────────┘ └─────────┘  │
                    └───────────────────────────┘
```

## 组件说明

### 1. 客户端层

- **多语言客户端**: Python、Go、Java、Rust
- **连接方式**: gRPC/Arrow Flight
- **负载均衡**: 支持 DNS 轮询和 gRPC-LB

### 2. 服务层

- **DataFusion 服务**: 基于 Foundations 的分布式查询服务
- **水平扩展**: 支持多实例部署
- **服务发现**: 自动注册和发现

### 3. 可观测性层

- **Vector Edge**: 边缘节点日志收集
- **Vector Aggregator**: 日志聚合和降采样
- **NATS**: 消息队列中间件

### 4. 存储层

- **ClickHouse**: 日志存储和分析
- **Prometheus**: 指标收集
- **Grafana**: 可视化仪表板

## 数据流

1. **查询请求**: 客户端 → 负载均衡器 → DataFusion 服务
2. **日志收集**: DataFusion 服务 → Vector Edge → NATS
3. **日志聚合**: NATS → Vector Aggregator → ClickHouse
4. **指标收集**: 所有组件 → Prometheus
5. **可视化**: Grafana 从 ClickHouse 和 Prometheus 读取数据

## 部署策略

### 开发环境

- 使用 Docker Compose 一键部署
- 单节点部署所有组件
- 适合开发和测试

### 生产环境

- 使用 Kubernetes 部署
- 多节点高可用部署
- 支持自动扩缩容

## 监控和告警

### 关键指标

- 查询 QPS 和延迟
- 服务可用性
- 资源使用率
- 错误率

### 告警规则

- 服务不可用
- 查询延迟过高
- 错误率超过阈值
- 资源使用率过高

## 安全考虑

- TLS 加密通信
- 服务间认证
- 网络隔离
- 访问控制

## 扩展性

- 水平扩展 DataFusion 服务
- 动态添加 Vector 节点
- 存储层分片
- 缓存层优化
